[Access LSASS Memory for Dump Creation]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 15d
alert.severity = 4
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Dump LSASS: https://research.splunk.com/endpoint/fb4c31b0-13e8-4155-8aa5-24de4b8d6717/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" `sysmon` EventCode=10 TargetImage=*lsass.exe CallTrace=*dbgcore.dll* OR CallTrace=*dbghelp.dll* \
| stats count min(_time) as firstTime max(_time) as lastTime by CallTrace EventID GrantedAccess Guid Opcode ProcessID SecurityID SourceImage SourceProcessGUID SourceProcessId TargetImage TargetProcessGUID TargetProcessId UserID dest granted_access parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product \
| `security_content_ctime(firstTime)` \
|`security_content_ctime(lastTime)` \
| `access_lsass_memory_for_dump_creation_filter`\
| eval alert_severity_id = 6

[Action sur la clé de registre Run]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 24d
alert.severity = 4
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Création ou modification de clé RUN\
Test OK
dispatch.earliest_time = -15m
dispatch.latest_time = now
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" sourcetype="WinEventLog"category="Registry" "*Run*" | eval alert_severity_id = 1

[Création tâche planifiée suspicieuse]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.severity = 4
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Test: Ok_
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod"\
(\
   (source="WinEventLog:Security" EventCode=4698)\
   OR\
   (\
     source="WinEventLog:Microsoft-Windows-Sysmon/Operational"\
     EventCode=1\
     AND (Image="*\\schtasks.exe" OR Image="*\\at.exe")\
   )\
)\
| eval suspicious_cmd = if(\
        like(CommandLine, "%powershell%")\
     OR like(CommandLine, "%cmd.exe%")\
     OR like(CommandLine, "%wscript%")\
     OR like(CommandLine, "%cscript%")\
     OR like(CommandLine, "%rundll32%")\
     OR like(CommandLine, "%mshta%")\
,1,0)\
| eval suspicious_path = if(\
        like(TaskName,"%AppData%")\
     OR like(TaskName,"%Temp%")\
     OR like(TaskName,"%Updater%")\
,1,0)\
| where suspicious_cmd=1 OR suspicious_path=1\
| table _time host User Image data.command_line TaskName EventCode\
| sort -_time\
| eval alert_severity_id = 5

[Detect Distributed Password Spray Attempts]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 14d
alert.severity = 4
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Password Spaying: https://research.splunk.com/application/b1a82fc8-8a9f-4344-9ec2-bde5c5331b57/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = | tstats `security_content_summariesonly` dc(Authentication.user) AS unique_accounts dc(Authentication.src) as unique_src values(Authentication.app) as app values(Authentication.src) as src count(Authentication.user) as total_failures from datamodel=Authentication.Authentication where Authentication.action="failure" NOT Authentication.src IN ("-","unknown") Authentication.user_agent="*" by Authentication.signature_id, Authentication.user_agent, sourcetype, _time  span=10m \
| `drop_dm_object_name("Authentication")` ```fill out time buckets for 0-count events during entire search length``` \
| appendpipe [\
| timechart limit=0 span=10m count \
| table _time] \
| fillnull value=0 unique_accounts, unique_src ``` Create aggregation field & apply to all null events``` \
| eval counter=sourcetype+"__"+signature_id \
| eventstats values(counter) as fnscounter \
| eval counter=coalesce(counter,fnscounter)  \
| stats values(total_failures) as total_failures values(signature_id) as signature_id values(src) as src values(sourcetype) as sourcetype values(app) as app count by counter unique_accounts unique_src user_agent _time\
  ``` remove 0 count rows where counter has data```\
\
| sort - _time unique_accounts \
| dedup _time counter ``` 3-sigma detection logic ``` \
| eventstats avg(unique_accounts) as comp_avg_user , stdev(unique_accounts) as comp_std_user avg(unique_src) as comp_avg_src , stdev(unique_src) as comp_std_src by counter user_agent \
| eval upperBoundUser=(comp_avg_user+comp_std_user*3), upperBoundsrc=(comp_avg_src+comp_std_src*3) \
| eval isOutlier=if((unique_accounts > 30 and unique_accounts >= upperBoundUser) and (unique_src > 30 and unique_src >= upperBoundsrc), 1, 0) \
| replace "::ffff:*" with * in src \
| where isOutlier=1 \
| foreach * \
    [ eval <<FIELD>> = if(<<FIELD>>="null",null(),<<FIELD>>)] \
\
| mvexpand src  \
| iplocation src  \
| table _time, unique_src, unique_accounts, total_failures, sourcetype, signature_id, user_agent, src, Country \
| eval date_wday=strftime(_time,"%a"), date_hour=strftime(_time,"%H") \
| `detect_distributed_password_spray_attempts_filter`\
| eval alert_severity_id = 5

[Dump LSASS via comsvcs DLL]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.expires = 14d
alert.severity = 4
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Dump LSASS: https://research.splunk.com/endpoint/8943b567-f14d-4ee8-a0bb-2121d4ce3184/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = | tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_rundll32` Processes.process=*comsvcs.dll* Processes.process IN ("*MiniDump*", "*#24*") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product \
| `drop_dm_object_name(Processes)` \
| `security_content_ctime(firstTime)` \
| `security_content_ctime(lastTime)` \
| `dump_lsass_via_comsvcs_dll_filter`\
| eval alert_severity_id = 6

[Dump LSASS via procdump]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.expires = 15d
alert.severity = 4
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Dump LSASS: https://research.splunk.com/endpoint/3742ebfe-64c2-11eb-ae93-0242ac130002/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = | tstats `security_content_summariesonly` \
  count min(_time) as firstTime \
        max(_time) as lastTime\
        \
from datamodel=Endpoint.Processes where \
\
`process_procdump`\
Processes.process IN (*-ma*, *-mm*, "*-mp*", */ma*, */mm*, "*/mp*")\
Processes.process IN (* ls*, "* keyiso*", "* samss*")\
\
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process \
   Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id\
   Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec\
   Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level\
   Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product\
\
\
| `drop_dm_object_name(Processes)`\
\
| `security_content_ctime(firstTime)`\
\
| `security_content_ctime(lastTime)`\
\
| `dump_lsass_via_procdump_filter`\
| eval alert_severity_id = 6

[Internal Vertical Port Scan]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.expires = 14d
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Scan de port: https://research.splunk.com/network/40d2dc41-9bbf-421a-a34b-8611271a6770/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = | tstats `security_content_summariesonly` values(All_Traffic.action) as action values(All_Traffic.src_category) as src_category values(All_Traffic.dest_zone) as dest_zone values(All_Traffic.src_zone) as src_zone count from datamodel=Network_Traffic where All_Traffic.src_ip IN ("10.0.0.0/8","172.16.0.0/12","192.168.0.0/16") by All_Traffic.src_ip All_Traffic.dest_port All_Traffic.dest_ip All_Traffic.transport All_Traffic.rule span=1s _time \
| `drop_dm_object_name("All_Traffic")` \
| eval gtime=_time \
| bin span=1h gtime \
| stats min(_time) as _time values(action) as action dc(eval(if(dest_port<1024 AND transport="tcp",dest_port,null))) as privilegedDestTcpPortCount dc(eval(if(transport="tcp",dest_port,null))) as totalDestTcpPortCount dc(eval(if(dest_port<1024 AND transport="udp",dest_port,null))) as privilegedDestUdpPortCount dc(eval(if(transport="udp",dest_port,null))) as totalDestUdpPortCount values(src_category) as src_category values(dest_zone) as dest_zone values(src_zone) as src_zone by src_ip dest_ip transport gtime \
| eval totalDestPortCount=totalDestUdpPortCount+totalDestTcpPortCount, privilegedDestPortCount=privilegedDestTcpPortCount+privilegedDestUdpPortCount\
| where (totalDestPortCount>=500 AND privilegedDestPortCount>=20) \
| fields - gtime \
| `internal_vertical_port_scan_filter`\
| eval alert_severity_id = 5

[Internal Vertical Port Scan - simple]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 14d
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Scan de port
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod"\
| stats dc(dest_port) as nb_ports by src_ip, dest_ip\
| where nb_ports > 1000\
| sort -nb_ports\
| eval alert_severity_id = 5

[Kerberoasting]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.expires = 24d
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Test: Ok_
dispatch.earliest_time = -15m
dispatch.latest_time = now
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" EventCode=4769\
Nom_du_service!=krbtgt\
| where NOT like(Nom_du_compte, "%$%")\
| eval alert_severity_id = 6

[Kerberoasting spn request with RC4 encryption]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 15d
alert.severity = 4
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Kerberoasting\
https://research.splunk.com/endpoint/5cc67381-44fa-4111-8a37-7a230943f027/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" `wineventlog_security` EventCode=4769 ServiceName!="*$" (TicketOptions=0x40810000 OR TicketOptions=0x40800000 OR TicketOptions=0x40810010) TicketEncryptionType=0x17 \
| stats count min(_time) as firstTime max(_time) as lastTime by Computer, user, service_id, service, TicketEncryptionType, TicketOptions \
| rename Computer as dest \
| `security_content_ctime(lastTime)` \
| `security_content_ctime(firstTime)` \
| `kerberoasting_spn_request_with_rc4_encryption_filter`\
| eval alert_severity_id = 5

[Linux Auditd Find Credentials From Password Managers]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-linux
alert.digest_mode = 0
alert.expires = 14d
alert.severity = 2
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Activité de password looting: https://beta.splunkresearch.com/endpoint/784241aa-85a5-4782-a503-d071bd3446f9/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" `linux_auditd` execve_command IN ("*find*", "*grep*") AND execve_command IN ("*.kdbx*", "*KeePass*", "*.enforced*", "*.lpdb*", "*.opvault*", "*.agilekeychain*", "*.dashlane*", "*.rfx*", "*passbolt*", "*.spdb*", "*StickyPassword*", "*.walletx*", "*enpass*", "*vault*", "*.kdb*") \
| rename host as dest \
| rename comm as process_name \
| rename exe as process \
| stats count min(_time) as firstTime max(_time) as lastTime by argc execve_command dest \
| `security_content_ctime(firstTime)` \
| `security_content_ctime(lastTime)` \
| `linux_auditd_find_credentials_from_password_managers_filter`\
| eval alert_severity_id = 1

[Linux Auditd Find Credentials From Password Stores]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alerte-linux
alert.digest_mode = 0
alert.expires = 14d
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = password looting: https://research.splunk.com/endpoint/4de73044-9a1d-4a51-a1c2-85267d8dcab3/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" `linux_auditd` execve_command IN ("*find*", "*grep*") AND execve_command IN ("*password*", "*pass *", "*credential*", "*creds*") \
| rename host as dest \
| rename comm as process_name \
| rename exe as process \
| stats count min(_time) as firstTime max(_time) as lastTime by argc execve_command dest \
| `security_content_ctime(firstTime)` \
| `security_content_ctime(lastTime)` \
| `linux_auditd_find_credentials_from_password_stores_filter`\
| eval alert_severity_id = 1

[Linux Auditd Possible Access To Credential Files]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alerte-linux
alert.digest_mode = 0
alert.expires = 14d
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Activité de password looting: https://research.splunk.com/endpoint/0419cb7a-57ea-467b-974f-77c303dfe2a3/
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" `linux_auditd`  proctitle IN ("*shadow*", "*passwd*") AND proctitle IN ("*cat *", "*nano *", "*vim *", "*vi *") \
| rename host as dest \
| stats count min(_time) as firstTime max(_time) as lastTime by proctitle  dest \
| `security_content_ctime(firstTime)` \
| `security_content_ctime(lastTime)` \
| `linux_auditd_possible_access_to_credential_files_filter`\
| eval alert_severity_id = 1

[Linux Password looting]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-linux
alert.expires = 24d
alert.severity = 4
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Test: Ok_
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" sourcetype="kunai_json"\
| spath path=data.command_line output=cmd\
| eval cmd=lower(trim(cmd))\
| eval loot=case(\
    like(cmd, "%cat /etc/passwd%"), "passwd_read",\
    like(cmd, "%cat /etc/shadow%"), "shadow_read",\
    like(cmd, "%cp /etc/passwd%"), "passwd_copy",\
    like(cmd, "%cp /etc/shadow%"), "shadow_copy",\
    like(cmd, "%scp%passwd%"), "passwd_exfil",\
    like(cmd, "%scp%shadow%"), "shadow_exfil",\
    like(cmd, "%tar%passwd%"), "passwd_archive",\
    like(cmd, "%tar%shadow%"), "shadow_archive",\
    like(cmd, "%unshadow%"), "unshadow",\
    like(cmd, "%hashcat%"), "hashcat"\
)\
| where isnotnull(loot)\
| table host cmd loot sourcetype\
| eval alert_title="Password Looting"\
| eval alert_description="Password Looting Kunai Linux"\
| rename sourcetype as alert_source\
| eval alert_source_event_time = strftime(_time, "%Y-%m-%d %H:%M:%S")\
| eval alert_severity_id=2\
| rename cmd as alert_source_content\
| eval alert_severity_id = 5

[Linux System Network Discovery]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alerte-linux
alert.expires = 14d
alert.severity = 2
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Multiples commandes d’énumération: https://research.splunk.com/endpoint/535cb214-8b47-11ec-a2c7-acde48001122/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = | tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Processes.action) as action values(Processes.dest) as dest values(Processes.original_file_name) as original_file_name values(Processes.parent_process) as parent_process values(Processes.parent_process_exec) as parent_process_exec values(Processes.parent_process_guid) as parent_process_guid values(Processes.parent_process_id) as parent_process_id values(Processes.parent_process_name) as parent_process_name values(Processes.parent_process_path) as parent_process_path values(Processes.process) as process values(Processes.process_exec) as process_exec values(Processes.process_guid) as process_guid values(Processes.process_hash) as process_hash values(Processes.process_id) as process_id values(Processes.process_integrity_level) as process_integrity_level values(Processes.process_name) as process_name values(Processes.process_path) as process_path values(Processes.user) as user  values(Processes.user_id) as user_id values(Processes.vendor_product) as vendor_product dc(Processes.process_name) as process_name_count from datamodel=Endpoint.Processes where Processes.process_name IN ("arp", "ifconfig", "ip", "netstat", "firewall-cmd", "ufw", "iptables", "ss", "route") by _time span=30m Processes.dest Processes.user \
| where process_name_count>=4 \
| `drop_dm_object_name(Processes)` \
| `security_content_ctime(firstTime)` \
| `security_content_ctime(lastTime)` \
| `linux_system_network_discovery_filter`\
| eval alert_severity_id = 1

[Malware Registry Abuses]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.expires = 14d
alert.severity = 4
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Création ou modification de clé RUN: https://www.splunk.com/en_us/blog/security/from-registry-with-love-malware-registry-abuses.html
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = | tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where (Registry.registry_path=*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunOnce OR Registry.registry_path=*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\StartupApproved\\Run OR Registry.registry_path=*\\currentversion\\run* OR Registry.registry_path=*\\currentVersion\\Windows\\Appinit_Dlls* OR Registry.registry_path=*\\CurrentVersion\\Winlogon\\Shell* OR Registry.registry_path=*\\CurrentVersion\\Winlogon\\Notify* OR Registry.registry_path=*\\CurrentVersion\\Winlogon\\Userinit* OR Registry.registry_path=*\\CurrentVersion\\Winlogon\\VmApplet* OR Registry.registry_path=*\\currentversion\\policies\\explorer\\run* OR Registry.registry_path=*\\currentversion\\runservices* OR Registry.registry_path=HKLM\\SOFTWARE\\Microsoft\\Netsh\\* OR (Registry.registry_path="*Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options*" AND Registry.registry_key_name=Debugger) OR (Registry.registry_path="*\\CurrentControlSet\\Control\\Lsa" AND Registry.registry_key_name="Security Packages") OR (Registry.registry_path="*\\CurrentControlSet\\Control\\Lsa\\OSConfig" AND Registry.registry_key_name="Security Packages") OR (Registry.registry_path="*\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\*") OR (Registry.registry_path="*currentVersion\\Windows" AND Registry.registry_key_name="Load") OR (Registry.registry_path="*\\CurrentVersion" AND Registry.registry_key_name="Svchost") OR (Registry.registry_path="*\\CurrentControlSet\Control\Session Manager"AND Registry.registry_key_name="BootExecute") OR (Registry.registry_path="*\\Software\\Run" AND Registry.registry_key_name="auto_update")) by Registry.dest Registry.user Registry.registry_path Registry.registry_value_name Registry.registry_value_data Registry.process_guid Registry.registry_key_name \
| `drop_dm_object_name(Registry)` \
| `security_content_ctime(firstTime)` \
| `security_content_ctime(lastTime)`\
| eval alert_severity_id = 5

[Modification clé registre RUN]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.expires = 24d
alert.severity = 2
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Test: OK_
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod"\
(\
    (\
        (EventCode=12 OR EventCode=13)\
        AND TargetObject="*\\Software\\Microsoft\\Windows\\CurrentVersion\\Run*"\
    )\
    OR\
    (\
        EventCode=4657\
        AND ObjectName="*\\Software\\Microsoft\\Windows\\CurrentVersion\\Run*"\
    )\
)\
| eval newval=coalesce(NewValue, Details)\
| search NOT newval="*OneDrive*" \
        NOT newval="*Teams*" \
        NOT newval="*EdgeUpdate*" \
        NOT newval="*GoogleUpdate*"\
| table _time host EventCode User TargetObject ObjectName Details NewValue\
| eval alert_severity_id = 1

[Linux Auditd Sudo Or Su Execution]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alerte-linux
alert.digest_mode = 0
alert.expires = 14d
alert.severity = 1
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Linux: https://research.splunk.com/endpoint/817a5c89-5b92-4818-a22d-aa35e1361afe/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="*" source=/var/log/kunai/events.log | spath input=_raw path=data.command_line output=cmd\
| search (cmd="*sudo *" OR cmd="*su *")\
| table _time host info.task.name info.task.user cmd\
| eval alert_severity_id = 1

[Reg exe Manipulating Windows Services Registry Keys]
action.email.inline = 1
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.expires = 14d
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Création ou modification de clé RUN: https://research.splunk.com/endpoint/8470d755-0c13-45b3-bd63-387a373c10cf/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = | tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Processes.process_name) as process_name values(Processes.parent_process_name) as parent_process_name values(Processes.user) as user FROM datamodel=Endpoint.Processes where Processes.process_name=reg.exe Processes.process=*reg* Processes.process=*add* Processes.process=*Services* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product \
| `drop_dm_object_name("Processes")` \
| `security_content_ctime(firstTime)` \
| `security_content_ctime(lastTime)` \
| `reg_exe_manipulating_windows_services_registry_keys_filter`\
| eval alert_severity_id = 5

[Registry Keys Used For Persistence]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.expires = 14d
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Création ou modification de clé RUN: https://research.splunk.com/endpoint/f5f6af30-7aa7-4295-bfe9-07fe87c01a4b/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = | tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where (Registry.registry_path=*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunOnce OR Registry.registry_path=*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\StartupApproved\\Run OR Registry.registry_path= "*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders\\*" OR Registry.registry_path= "*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\\*" OR Registry.registry_path=*\\currentversion\\run* OR Registry.registry_path=*\\currentVersion\\Windows\\Appinit_Dlls* OR Registry.registry_path=*\\CurrentVersion\\Winlogon\\Shell* OR Registry.registry_path=*\\CurrentVersion\\Winlogon\\Notify* OR Registry.registry_path=*\\CurrentVersion\\Winlogon\\Userinit* OR Registry.registry_path=*\\CurrentVersion\\Winlogon\\VmApplet* OR Registry.registry_path=*\\currentversion\\policies\\explorer\\run* OR Registry.registry_path=*\\currentversion\\runservices* OR Registry.registry_path=*\\SOFTWARE\\Microsoft\\Netsh\\* OR Registry.registry_path= "*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\\Common Startup" OR Registry.registry_path= *\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\SharedTaskScheduler OR Registry.registry_path= *\\Classes\\htmlfile\\shell\\open\\command OR (Registry.registry_path="*Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options*" AND Registry.registry_key_name=Debugger) OR (Registry.registry_path="*\\CurrentControlSet\\Control\\Lsa" AND Registry.registry_key_name="Security Packages") OR (Registry.registry_path="*\\CurrentControlSet\\Control\\Lsa\\OSConfig" AND Registry.registry_key_name="Security Packages") OR (Registry.registry_path="*\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\*") OR (Registry.registry_path="*currentVersion\\Windows" AND Registry.registry_key_name="Load") OR (Registry.registry_path="*\\CurrentVersion" AND Registry.registry_key_name="Svchost") OR (Registry.registry_path="*\\CurrentControlSet\Control\Session Manager"AND Registry.registry_key_name="BootExecute") OR (Registry.registry_path="*\\Software\\Run" AND Registry.registry_key_name="auto_update")) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product \
| `drop_dm_object_name(Registry)` \
| `security_content_ctime(firstTime)` \
| `security_content_ctime(lastTime)` \
| `registry_keys_used_for_persistence_filter`\
| eval alert_severity_id = 5

[Registry key modifications]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.expires = 14d
alert.severity = 2
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Création ou modification de clé RUN: https://lantern.splunk.com/Security_Use_Cases/Security_Monitoring/Detecting_a_ransomware_attack/Registry_key_modifications
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = | tstats allow_old_summaries=true count, values("Registry.registry_key_name") AS registry_key_name, values("Registry.registry_path") AS registry_path, min(_time) AS firstTime, max(_time) AS lastTime FROM datamodel=Endpoint.Registry WHERE ("Registry.registry_path"=*currentversion\\run* OR "Registry.registry_path"=*currentVersion\\Windows\\Appinit_Dlls* OR "Registry.registry_path"=CurrentVersion\\Winlogon\\Shell* OR "Registry.registry_path"=*CurrentVersion\\Winlogon\\Userinit* OR "Registry.registry_path"=*CurrentVersion\\Winlogon\\VmApplet* OR "Registry.registry_path"=*currentversion\\policies\\explorer\\run* OR "Registry.registry_path"=*currentversion\\runservices* OR "Registry.registry_path"=*\\CurrentControlSet\\Control\\Lsa\\* OR "Registry.registry_path"="*Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options*" OR "Registry.registry_path"=HKLM\\SOFTWARE\\Microsoft\\Netsh\\*) BY "Registry.dest", "Registry.user" \
| rename "Registry.*" AS "*"\
| convert timeformat="%Y-%m-%dT%H:%M:%S" ctime(lastTime) \
| convert timeformat="%Y-%m-%dT%H:%M:%S" ctime(firstTime)\
| eval alert_severity_id = 1

[Rubeus Command Line Parameters]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 15d
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = AS-reproasting/Kerberoasting: \
https://research.splunk.com/endpoint/cca37478-8377-11ec-b59a-acde48001122/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = | tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process = "*ptt /ticket*" OR Processes.process = "* monitor /interval*" OR Processes.process ="* asktgt* /user:*" OR Processes.process ="* asktgs* /service:*" OR Processes.process ="* golden* /user:*" OR Processes.process ="* silver* /service:*" OR Processes.process ="* kerberoast*" OR Processes.process ="* asreproast*" OR Processes.process = "* renew* /ticket:*" OR Processes.process = "* brute* /password:*" OR Processes.process = "* brute* /passwords:*" OR Processes.process ="* harvest*") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product \
| `drop_dm_object_name(Processes)` \
| `security_content_ctime(firstTime)` \
| `security_content_ctime(lastTime)` \
| `rubeus_command_line_parameters_filter`\
| eval alert_severity_id = 5

[Scan réseau (port ou ip)]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.expires = 24d
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Test: OK_
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" sourcetype="wineventlog:microsoft-windows-sysmon/operational" EventCode=3\
| rename SourceIp as src_ip DestinationIp as dest_ip DestinationPort as dest_port\
| stats dc(dest_port) as num_dest_port dc(dest_ip) as num_dest_ip by src_ip\
| where num_dest_port > 50 OR num_dest_ip > 100\
| eval alert_severity_id = 1

[Suspicious HTTP traffic that may be indicative of a beaconing attempt]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 14d
alert.severity = 2
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Activité de beaconing CnC: https://medium.com/@nirvana.elahi/how-detect-http-beacon-traffic-with-splunk-d748a9f2613f
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" sourcetype="access_combined" method=GET status=200 bytes > 0 referer="*" user_agent="*" | eval epoch_time=_time | stats count by clientip, user_agent, referer, epoch_time | streamstats count | where count>1 | fields - count\
| eval alert_severity_id = 5

[Suspicious Linux Discovery Commands]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alerte-linux
alert.expires = 14h
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Multiples commandes d’énumération: https://research.splunk.com/endpoint/0edd5112-56c9-11ec-b990-acde48001122/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = | tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Processes.action) as action values(Processes.original_file_name) as original_file_name values(Processes.parent_process) as parent_process values(Processes.parent_process_exec) as parent_process_exec values(Processes.parent_process_guid) as parent_process_guid values(Processes.parent_process_id) as parent_process_id values(Processes.parent_process_name) as parent_process_name values(Processes.parent_process_path) as parent_process_path values(Processes.process) as process values(Processes.process_exec) as process_exec values(Processes.process_guid) as process_guid values(Processes.process_hash) as process_hash values(Processes.process_id) as process_id values(Processes.process_integrity_level) as process_integrity_level values(Processes.process_path) as process_path values(Processes.user_id) as user_id values(Processes.vendor_product) as vendor_product dc(Processes.process) as distinct_commands dc(Processes.process_name) as distinct_process_names from datamodel=Endpoint.Processes where [\
|inputlookup linux_tool_discovery_process \
| rename process as Processes.process \
|table Processes.process] by _time span=5m Processes.user Processes.dest \
| `drop_dm_object_name(Processes)` \
| `security_content_ctime(firstTime)` \
| `security_content_ctime(lastTime)` \
| where distinct_commands > 40 AND distinct_process_names > 3 \
| `suspicious_linux_discovery_commands_filter`\
| eval alert_severity_id = 1

[Utilisation de LSASS]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 24d
alert.severity = 4
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Dump LSASS\
Test OK
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.page.search.mode = verbose
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" "lsass" source="WinEventLog:Security" Nom_du_processus="C:\\Windows\\System32\\lsass.exe"\
| eval alert_severity_id = 6

[Windows AD Suspicious Attribute Modification]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 14d
alert.severity = 2
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Shadow credential: https://research.splunk.com/endpoint/5682052e-ce55-4f9f-8d28-59191420b7e0/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" `wineventlog_security` EventCode=5136 AttributeLDAPDisplayName IN ("msDS-AllowedToDelegateTo","msDS-AllowedToActOnBehalfOfOtherIdentity","scriptPath","msTSInitialProgram") OperationType=%%14674  ```Changes to the attribute "msDS-KeyCredentialLink" are also worth moniroting, however tuning will need to be applied``` \
| table _time ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId DSName AttributeValue AttributeLDAPDisplayName  \
| rename SubjectLogonId as TargetLogonId, src_user as initiator, _time as eventTime  \
| appendpipe [\
| map search="search `wineventlog_security` EventCode=4624 TargetLogonId=$TargetLogonId$"]  \
| stats min(eventTime) as _time values(initiator) as src_user, values(DSName) as targetDomain, values(ObjectDN) as ObjectDN, values(ObjectClass) as ObjectClass, values(src_category) as src_category, values(src_ip) as src_ip values(LogonType) as LogonType values(AttributeValue) as AttributeValue values(AttributeLDAPDisplayName) as AttributeLDAPDisplayName by TargetLogonId  \
| rex field=ObjectDN "^CN=(?P<cn>.*?),[A-Z]{2}\="  \
| eval dest=if(ObjectClass="computer",cn,null), user=if(ObjectClass="user",cn,null) \
| fields - cn \
| `windows_ad_suspicious_attribute_modification_filter`\
| eval alert_severity_id = 1

[Windows Hidden Schedule Task Settings]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 15d
alert.severity = 4
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Création d'une tâche planifiée suspecte: https://research.splunk.com/endpoint/0b730470-5fe8-4b13-93a7-fe0ad014d0cc/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" `wineventlog_security`\
EventCode=4698 \
TaskContent = "*&lt;Hidden&gt;true&lt;/Hidden&gt;*"\
\
| stats count min(_time) as firstTime max(_time) as lastTime\
  by TaskName TaskContent action signature status dest\
\
| `security_content_ctime(firstTime)` \
\
| `security_content_ctime(lastTime)`\
\
| `windows_hidden_schedule_task_settings_filter`\
| eval alert_severity_id = 1

[Modification clé registre RUN - Not Authority\system]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.expires = 24d
alert.severity = 4
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" (     (         (EventCode=12 OR EventCode=13)         AND TargetObject="*\\Software\\Microsoft\\Windows\\CurrentVersion\\Run*"     )     OR     (         EventCode=4657         AND ObjectName="*\\Software\\Microsoft\\Windows\\CurrentVersion\\Run*"     ) ) | eval newval=coalesce(NewValue, Details) | search NOT newval="*OneDrive*"          NOT newval="*Teams*"          NOT newval="*EdgeUpdate*"          NOT newval="*GoogleUpdate*"  User!="NT AUTHORITY\\SYSTEM"  Image!="C:\\WINDOWS\\system32\\sihost.exe"  Image!="C:\\WINDOWS\\system32\\userinit.exe"  Image!="C:\\Windows\\System32\\OneDriveSetup.exe"  Image!="C:\\WINDOWS\\Explorer.EXE"  Image!="C:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe" | table  _time host EventCode User TargetObject ObjectName Details NewValue    | eval  alert_severity_id = 1

[Windows Possible Credential Dumping]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 15d
alert.severity = 4
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Dump LSASS: https://research.splunk.com/endpoint/e4723b92-7266-11ec-af45-acde48001122/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" `sysmon` EventCode=10 TargetImage=*\\lsass.exe granted_access IN ("0x01000", "0x1010", "0x1038", "0x40", "0x1400", "0x1fffff", "0x1410", "0x143a", "0x1438", "0x1000") CallTrace IN ("*dbgcore.dll*", "*dbghelp.dll*", "*ntdll.dll*", "*kernelbase.dll*", "*kernel32.dll*") NOT SourceUser IN ("NT AUTHORITY\\SYSTEM", "NT AUTHORITY\\NETWORK SERVICE") \
| stats count min(_time) as firstTime max(_time) as lastTime by CallTrace EventID GrantedAccess Guid Opcode ProcessID SecurityID SourceImage SourceProcessGUID SourceProcessId TargetImage TargetProcessGUID TargetProcessId UserID dest granted_access parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product \
| `security_content_ctime(firstTime)` \
| `security_content_ctime(lastTime)` \
| `windows_possible_credential_dumping_filter`\
| eval alert_severity_id = 6

[Windows PowerShell ScheduleTask]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 15d
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Création d'une tâche planifiée suspecte: https://research.splunk.com/endpoint/ddf82fcb-e9ee-40e3-8712-a50b5bf323fc/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" `powershell` EventCode=4104 ScriptBlockText IN ("*New-ScheduledTask*", "*New-ScheduledTaskAction*", "*New-ScheduledTaskSettingsSet*", "*New-ScheduledTaskTrigger*", "*Register-ClusteredScheduledTask*", "*Register-ScheduledTask*", "*Set-ClusteredScheduledTask*", "*Set-ScheduledTask*", "*Start-ScheduledTask*", "*Enable-ScheduledTask*") \
| fillnull \
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText \
| `security_content_ctime(firstTime)` \
| `security_content_ctime(lastTime)` \
| `windows_powershell_scheduletask_filter`\
| eval alert_severity_id = 5

[Windows Scheduled Task Created Via XML]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.expires = 15d
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Création d'une tâche planifiée suspecte: https://research.splunk.com/endpoint/7e03b682-3965-4598-8e91-a60a40a3f7e4/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = | tstats `security_content_summariesonly` \
  count min(_time) as firstTime\
        max(_time) as lastTime\
\
from datamodel=Endpoint.Processes where \
\
`process_schtasks`\
Processes.process IN ("* /create *", "* -create *")\
Processes.process IN ("* /xml *", "* -xml *")\
\
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process \
   Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id \
   Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec \
   Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level \
   Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product\
\
\
| `drop_dm_object_name(Processes)` \
\
| `security_content_ctime(firstTime)` \
\
| `security_content_ctime(lastTime)`\
\
| `windows_scheduled_task_created_via_xml_filter`\
| eval alert_severity_id = 5

[Windows Scheduled Task with Suspicious Command]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 15d
alert.severity = 5
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Création d'une tâche planifiée suspecte: https://research.splunk.com/endpoint/1f44c126-c26a-4dd3-83bb-0f9a0f03ecc3/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" `wineventlog_security` EventCode IN (4698,4700,4702)\
\
| eval TaskContent = case(isnotnull(TaskContentNew),TaskContentNew,true(),TaskContent)\
\
| xmlkv TaskContent\
\
| stats count min(_time) as firstTime max(_time) as lastTime latest(Arguments) as Arguments latest(Author) as Author by Computer, Caller_User_Name, TaskName, Command, Enabled, Hidden, EventCode\
\
| lookup windows_suspicious_tasks task_command as Command \
\
| where tool == "shell command use" OR tool == "suspicious paths"\
\
| eval command=TaskName, process=Command+if(isnotnull(Arguments)," ".Arguments,""), src_user=Author, user = Caller_User_Name, dest = Computer, signature_id = EventCode \
\
| `security_content_ctime(firstTime)` \
\
| `security_content_ctime(lastTime)`\
\
| `windows_scheduled_task_with_suspicious_command_filter`\
| eval alert_severity_id = 5

[Windows Service Created with Suspicious Service Name2]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 14d
alert.severity = 4
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Création d’un service suspect: https://research.splunk.com/endpoint/35eb6d19-a497-400c-93c5-645562804b11/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=* `wineventlog_system` EventCode=7045 \
\
| stats values(ImagePath) as process, count, min(_time) as firstTime, max(_time) as lastTime values(EventCode) as signature by Computer, ServiceName, StartType, ServiceType, UserID\
\
| eval process_name = replace(mvindex(split(process,"\\"),-1), "\"", "")\
\
| rename Computer as dest, ServiceName as object_name, ServiceType as object_type, UserID as user_id\
\
| lookup windows_suspicious_services service_name as object_name\
\
| where isnotnull(tool_name)\
\
| `security_content_ctime(firstTime)` \
\
| `security_content_ctime(lastTime)` \
\
| `windows_service_created_with_suspicious_service_name_filter`\
| eval alert_severity_id = 1

[Windows Service Created with Suspicious Service Path]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 14d
alert.severity = 4
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Création d’un service suspect: https://research.splunk.com/endpoint/429141be-8311-11eb-adb6-acde48001122/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" `wineventlog_system` EventCode=7045 ImagePath = "*.exe" NOT (ImagePath IN ("*:\\Windows\\*", "*:\\Program File*", "*:\\Programdata\\*", "*%systemroot%\\*")) \
| stats count min(_time) as firstTime max(_time) as lastTime by EventCode ImagePath ServiceName ServiceType StartType Computer UserID \
| rename Computer as dest\
| `security_content_ctime(firstTime)` \
| `security_content_ctime(lastTime)` \
| `windows_service_created_with_suspicious_service_path_filter`\
| eval alert_severity_id = 5

[Windows Service Creation Using Registry Entry]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.expires = 14d
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Création ou modification de clé RUN: https://research.splunk.com/endpoint/25212358-948e-11ec-ad47-acde48001122/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = | tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path="*\\SYSTEM\\CurrentControlSet\\Services*" Registry.registry_value_name = ImagePath) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product \
| `drop_dm_object_name(Registry)` \
| where isnotnull(registry_value_data) \
| `security_content_ctime(firstTime)` \
| `security_content_ctime(lastTime)` \
| `windows_service_creation_using_registry_entry_filter`\
| eval alert_severity_id = 5

[Windows Terminating Lsass Process]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 14d
alert.severity = 4
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Dump LSASS: https://research.splunk.com/endpoint/7ab3c319-a4e7-4211-9e8c-40a049d0dba6/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" `sysmon` EventCode=10 TargetImage=*lsass.exe GrantedAccess = 0x1 \
| stats count min(_time) as firstTime max(_time) as lastTime by CallTrace EventID GrantedAccess Guid Opcode ProcessID SecurityID SourceImage SourceProcessGUID SourceProcessId TargetImage TargetProcessGUID TargetProcessId UserID dest granted_access parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product \
| `security_content_ctime(firstTime)` \
| `security_content_ctime(lastTime)` \
| `windows_terminating_lsass_process_filter`\
| eval alert_severity_id = 6

[cat /etc/passwd]
action.list = 1
action.list.severity = 4
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alerte-linux
alert.digest_mode = 0
alert.expires = 24d
alert.severity = 4
alert.suppress = 0
alert.suppress.period = 60s
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Utilise les logs de kunai pour vérifier si un user utilise le noyau pour faire un cat sur le fichier /etc/passwd
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" source=/var/log/kunai/events.log | spath input=_raw path=data.command_line output=cmd\
| search cmd="*etc/passwd*"\
| table _time host info.task.name info.task.user cmd\
| eval alert_severity_id = 4

[enumération]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-linux
alert.expires = 24d
alert.severity = 1
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Test: Ok_
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" sourcetype="kunai_json"\
| spath\
| spath path=data.command_line output=cmd\
| search cmd!=""\
| eval suspicious_command=case(\
    match(cmd, "whoami"), "whoami",\
    match(cmd, "\bid\b"), "id",\
    match(cmd, "uname -a"), "uname",\
    match(cmd, "hostname"), "hostname",\
    match(cmd, "dmesg"), "dmesg",\
    match(cmd, "uptime"), "uptime",\
    match(cmd, "\benv\b"), "env",\
\
    match(cmd, "ifconfig"), "ifconfig",\
    match(cmd, "ip addr"), "ip addr",\
    match(cmd, "ip link"), "ip link",\
    match(cmd, "ip route"), "ip route",\
    match(cmd, "\bss\b"), "ss",\
    match(cmd, "netstat"), "netstat",\
    match(cmd, "\barp\b"), "arp",\
    match(cmd, "\bdig\b"), "dig",\
    match(cmd, "nslookup"), "nslookup",\
    match(cmd, "curl"), "curl",\
    match(cmd, "wget"), "wget",\
\
    match(cmd, "cat /etc/passwd"), "passwd",\
    match(cmd, "cat /etc/shadow"), "shadow",\
    match(cmd, "getent passwd"), "getent passwd",\
    match(cmd, "groups"), "groups",\
    match(cmd, "lastlog"), "lastlog",\
\
    match(cmd, "ps aux"), "ps aux",\
    match(cmd, "top"), "top",\
    match(cmd, "journalctl"), "journalctl",\
\
    match(cmd, "ls -la"), "ls -la",\
    match(cmd, "find /"), "find",\
    match(cmd, "stat "), "stat",\
    match(cmd, "df -h"), "df -h",\
    match(cmd, "du -sh"), "du -sh",\
    match(cmd, "mount"), "mount",\
\
    match(cmd, "crontab -l"), "crontab",\
\
    match(cmd, "getcap"), "getcap"\
)\
| search suspicious_command!=""\
| bin _time span=1m\
| eval alert_source_event_time = strftime(_time, "%Y-%m-%d %H:%M:%S")\
| stats dc(suspicious_command) as uniq values(suspicious_command) as commandes by host alert_source_event_time\
| where uniq >= 10\
| eval alert_title="Commande d'énumération Linux"\
| eval alert_description="Commande d'énumération Linux"\
| rename sourcetype as alert_source\
| eval alert_severity_id = 1\
| rename commandes as alert_source_content

[Test - Création de tâche planifiée Windows]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 24d
alert.severity = 2
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = TEST OK
dispatch.earliest_time = -15m
dispatch.latest_time = now
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" sourcetype="WinEventLog" source="wineventlog:security" EventCode=4698   Task_Name!="\\OneDrive Standalone Update Task-*" AND Task_Name!="\\OneDrive Startup Task-*" AND Task_Name!="\\OneDrive Reporting Task-*"  Task_Name!="\\Microsoft\\Office\\*"  Task_Name!="\\Microsoft\\Windows\\GroupPolicy\\*"  Task_Name!="\\GoogleUserPEH\\RunPlatformExperienceHelper_*" | eval alert_severity_id = 4

[DUMP LSASS]
action.list = 1
action.list.severity = 5
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.expires = 24d
alert.severity = 5
alert.suppress = 0
alert.suppress.period = 60s
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = test: OK_
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" | where process_name IN ("procdump.exe", "procdump64.exe", "mimikatz.exe")     OR CommandLine LIKE "%lsass%"      OR CommandLine LIKE "%procdump -ma%"     OR CommandLine LIKE "%sekurlsa%"  | search ParentImage!="C:\\Windows\\System32\\wininit.exe" | table  _time host user process_name CommandLine ParentImage ParentCommandLine  | eval  alert_severity_id = 6

[Beaconing Linux]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-linux
alert.severity = 2
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
display.events.fields = ["host","source","sourcetype","object"]
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" source=/var/log/kunai/events.log\
| stats count by data.src.ip, data.dst.ip\
| where count > 100\
| eval alert_severity_id = 5

[Potential C2C Beaconning Windows]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 14d
alert.severity = 2
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
dispatch.earliest_time = -1d
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" sourcetype=WinEventLog src_ip="*" dest_ip="*"\
| stats count by src_ip, dest_ip\
| where count > 100\
| eval alert_severity_id = 5

[ASREP-Roasting]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.expires = 24d
alert.severity = 2
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Test: OK_
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" EventCode=4768 | eval PreAuthType = coalesce('Type de pré-authentification','PreAuth_Type','Pre-Authentication-Type',"0") | where PreAuthType="0"  | search Ticket_Encryption_Type!=0x12 | table  _time, host, src, Account_Name, Service_Name, PreAuthType  | rename  src AS "Source IP", Account_Name AS "User", Service_Name AS "Service" | eval alert_severity_id = 6

[Check for High-Frequency C2 Communication]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 14d
alert.severity = 2
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Activité de beaconing CnC: https://systemweakness.com/detecting-malware-c2-traffic-a-step-by-step-guide-using-splunk-python-19a1b9500772
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod"\
| stats count by dest_ip, dest_domain\
| where count > 50\
| eval alert_severity_id = 6

[Check for Periodic Beaconing Behavior]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 14d
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Activité de beaconing CnC: https://systemweakness.com/detecting-malware-c2-traffic-a-step-by-step-guide-using-splunk-python-19a1b9500772
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod"  sourcetype=firewall\
| bin _time span=10s\
| stats count by _time, src_ip, dest_ip\
| where count > 1\
| eval alert_severity_id = 6

[Creation of lsass Dump with Taskmgr]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 15d
alert.severity = 4
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Dump LSASS: https://research.splunk.com/endpoint/b2fbe95a-9c62-4c12-8a29-24b97e84c0cd/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" `sysmon` EventID=11 process_name=taskmgr.exe TargetFilename=*lsass*.dmp \
| stats count min(_time) as firstTime max(_time) as lastTime by action dest file_name file_path  process_guid process_id user_id vendor_product process_name TargetFilename \
| `security_content_ctime(firstTime)` \
| `security_content_ctime(lastTime)` \
| `creation_of_lsass_dump_with_taskmgr_filter`\
| eval alert_severity_id = 6

[Création ou modification de tâche planifiée]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.severity = 1
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Test OK
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.events.fields = ["host","source","sourcetype","EventCode"]
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" (EventCode=7045 OR EventCode=4697)   Service_File_Name!="C:\\WINDOWS\\system32\\svchost.exe*"  Service_File_Name!="\"C:\\Program Files (x86)\\Microsoft OneDrive*"  Service_File_Name!="C:\\WINDOWS\\system32\\CredentialEnrollmentManager.exe" | eval alert_severity_id = 1

[Création service suspect]
action.email.inline = 1
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.severity = 4
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Test: Ok_
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" \
(\
    (source="WinEventLog:Security" EventCode=4697)\
    OR\
    (source="WinEventLog:Microsoft-Windows-Sysmon/Operational"\
        EventCode=1\
        AND Image="*\\sc.exe"\
    )\
)\
| eval suspicious_binpath = case(\
        source="WinEventLog:Security"\
        AND (\
               like(Nom_de_fichier_du_service, "%\\Temp\\%")\
            OR like(Nom_de_fichier_du_service, "%\\AppData\\%")\
            OR like(Nom_de_fichier_du_service, "%\\Users\\Public%")\
        ), 1,\
\
        source="WinEventLog:Microsoft-Windows-Sysmon/Operational"\
        AND (\
               like(CommandLine, "%powershell%")\
            OR like(CommandLine, "%mshta%")\
            OR like(CommandLine, "%wscript%")\
            OR like(CommandLine, "%cscript%")\
            OR like(CommandLine, "%rundll32%")\
            OR like(CommandLine, "%cmd.exe /c%")\
            OR like(CommandLine, "%cmd.exe /k%")\
            OR like(CommandLine, "%C:\\Users\\Public%")\
            OR like(CommandLine, "%\\Downloads\\%")\
            OR like(CommandLine, "%\\Desktop\\%")\
            OR like(CommandLine, "%C:\\Windows\\Temp\\%")\
            OR like(CommandLine, "%\\AppData\\Local\\Temp%")\
        ), 1,\
\
        true(), 0\
)\
| where suspicious_binpath=1\
| eval ServiceName = coalesce(Nom_du_service, ServiceName)\
| rex field=CommandLine "create\s+(?<ServiceName>[^\s]+)"\
| eval BinPath = coalesce(Nom_de_fichier_du_service, BinPath)\
| rex field=CommandLine "binPath=\s+\"(?<BinPath>[^\"]+)\""\
| eval Account = coalesce(Nom_du_compte, User)\
| table _time host source EventCode ServiceName BinPath CommandLine Account\
| sort - _time\
| eval alert_severity_id = 5

[Detect Password Spray Attempts]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 15d
alert.severity = 4
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = https://research.splunk.com/application/086ab581-8877-42b3-9aee-4a7ecb0923af/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = | tstats `security_content_summariesonly` values(Authentication.user) AS unique_user_names dc(Authentication.user) AS unique_accounts values(Authentication.app) as app count(Authentication.user) as total_failures from datamodel=Authentication.Authentication where Authentication.action="failure" NOT Authentication.src IN ("-","unknown") by Authentication.action Authentication.app Authentication.authentication_method Authentication.dest \
  Authentication.signature Authentication.signature_id Authentication.src sourcetype _time span=5m  \
\
| `drop_dm_object_name("Authentication")`\
    ```fill out time buckets for 0-count events during entire search length```\
\
| appendpipe [\
| timechart limit=0 span=5m count \
| table _time] \
| fillnull value=0 unique_accounts\
  ``` Create aggregation field & apply to all null events```\
\
| eval counter=src+"__"+sourcetype+"__"+signature_id  \
| eventstats values(counter) as fnscounter  \
| eval counter=coalesce(counter,fnscounter) \
  ``` stats version of mvexpand ```\
\
| stats values(app) as app values(unique_user_names) as unique_user_names values(total_failures) as total_failures values(src) as src values(signature_id) as signature_id values(sourcetype) as sourcetype count by counter unique_accounts _time\
    ``` remove duplicate time buckets for each unique source```\
\
| sort - _time unique_accounts \
| dedup _time counter\
    ```Find the outliers```\
\
| eventstats avg(unique_accounts) as comp_avg , stdev(unique_accounts) as comp_std by counter \
| eval upperBound=(comp_avg+comp_std*3) \
| eval isOutlier=if(unique_accounts > 30 and unique_accounts >= upperBound, 1, 0) \
| replace "::ffff:*" with * in src  \
| where isOutlier=1  \
| foreach * \
    [ eval <<FIELD>> = if(<<FIELD>>="null",null(),<<FIELD>>)] \
\
| table _time, src, action, app, unique_accounts, unique_user_names, total_failures, sourcetype, signature_id, counter \
| `detect_password_spray_attempts_filter`\
| eval alert_severity_id = 6

[Detection: Kerberos Pre-Authentication Flag Disabled in UserAccountControl]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 14d
alert.severity = 1
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = AS-reproasting: admin miss config\
https://research.splunk.com/endpoint/0cb847ee-9423-11ec-b2df-acde48001122/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" `wineventlog_security` EventCode=4738 MSADChangedAttributes="*\'Don\'t Require Preauth\' - Enabled*" \
|rename Account_Name as user \
| table EventCode, user, dest, Security_ID, MSADChangedAttributes \
| `kerberos_pre_authentication_flag_disabled_in_useraccountcontrol_filter`\
| eval alert_severity_id = 5

[Detection: Kerberos Pre-Authentication Flag Disabled with PowerShell]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.digest_mode = 0
alert.expires = 14d
alert.severity = 1
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = AS-reproasting: admin misconfig\
https://research.splunk.com/endpoint/59b51620-94c9-11ec-b3d5-acde48001122/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="prod" `powershell` EventCode=4104 (ScriptBlockText = "*Set-ADAccountControl*" AND ScriptBlockText="*DoesNotRequirePreAuth:$true*") \
| fillnull \
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText \
| `security_content_ctime(firstTime)` \
| `security_content_ctime(lastTime)` \
| `kerberos_pre_authentication_flag_disabled_with_powershell_filter`\
| eval alert_severity_id = 5

[Internal Horizontal Port Scan]
action.webhook = 1
action.webhook.enable_allowlist = 0
action.webhook.param.url = http://soc_n8n:5678/webhook/alert-windows
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Scan de port: https://research.splunk.com/network/1ff9eb9a-7d72-4993-a55e-59a839e607f1/
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = | tstats `security_content_summariesonly` values(All_Traffic.action) as action values(All_Traffic.src_category) as src_category values(All_Traffic.dest_zone) as dest_zone values(All_Traffic.src_zone) as src_zone values(All_Traffic.src_port) as src_port count from datamodel=Network_Traffic where All_Traffic.src_ip IN ("10.0.0.0/8","172.16.0.0/12","192.168.0.0/16") by All_Traffic.src_ip All_Traffic.dest_port All_Traffic.dest_ip All_Traffic.transport All_Traffic.rule span=1s _time \
| `drop_dm_object_name("All_Traffic")` \
| eval gtime=_time \
| bin span=1h gtime \
| stats min(_time) as _time values(action) as action dc(dest_ip) as totalDestIPCount values(src_category) as src_category values(dest_zone) as dest_zone values(src_zone) as src_zone by src_ip dest_port gtime transport \
| where totalDestIPCount>=100 \
| eval dest_port=transport + "/" + dest_port \
| stats min(_time) as _time values(action) as action sum(totalDestIPCount) as totalDestIPCount values(src_category) as src_category values(dest_port) as dest_ports values(dest_zone) as dest_zone values(src_zone) as src_zone by src_ip gtime \
| fields - gtime \
| `internal_horizontal_port_scan_filter`\
| eval alert_severity_id = 4
